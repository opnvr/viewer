<!doctype html>
<html>

<head>
    <title>NVR Viewer</title>
    <style>
        html,
        body {
            min-height: 100%;
            margin: 0;
            background-color: black;
            overflow-y: hide;
        }

        .grid2x2 {
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            flex-direction: row;
            align-items: stretch;
        }

        .grid2x2>div {
            display: flex;
            flex-basis: 33%;
            justify-content: center;
            flex-direction: column;
            /*height: 302px;*/
        }

        .grid2x2>div>video {
            display: flex;
            justify-content: center;
            flex-direction: row;
            width: 100%;
            object-fit: fill;
        }

        .box {
            position: relative;
        }

        .box > span.status {
            color: white;
            position: absolute;
            left: 5px;
            bottom: 0;
            background-color: black;
        }

        .box > span.state {
            color: white;
            position: absolute;
            left: 5px;
            bottom: 20px;
            background-color: black;
        }

    </style>
</head>

<body>
    <div class="grid2x2">
        <div class="box" id="videoPlayer1">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>
        <div class="box" id="videoPlayer2">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>
        <div class="box" id="videoPlayer3">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>
        <div class="box" id="videoPlayer4">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>

        <div class="box" id="videoPlayer5">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>
        <div class="box" id="videoPlayer6">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>
        <div class="box" id="videoPlayer7">
            <video autoplay muted></video>
            <span class="status"></span>
            <span class="state"></span>
        </div>
    </div>

    <script type="text/javascript">
    (function () {

        function videoSource (id, selector) {
            var buffer;
            var websocket;

            // Pre alloc buffer due updating delay
            var buffer_size = 5*1024*1024;
            var buffer_index = 0;
            var frag_mp4_buffer = new Uint8Array(buffer_size);
            var video = document.querySelector(selector);
            var mediaSource = new MediaSource();

            // mediaSource.addEventListener('sourceended', function(e) { console.log('sourceended: ' + mediaSource.readyState); });
            // mediaSource.addEventListener('sourceclose', function(e) { console.log('sourceclose: ' + mediaSource.readyState); });
            // mediaSource.addEventListener('error', function(e) { console.log('error: ' + mediaSource.readyState); });

            video.src = window.URL.createObjectURL(mediaSource);
            video.playbackRate = 1.06

            mediaSource.addEventListener('sourceopen', function(e) {
                console.log('sourceopen: ' + mediaSource.readyState);

                buffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E"');
                buffer.mode = 'sequence'
            }, false);

            console.log('Play')
            video.play()
                .then(a => {
                    console.log('Playing', a)
                })
                .catch(err => {
                    console.error('Failed', err)
                })


            setInterval(() => {

                if(video.seekable.length) {
                    var seekableEnd = video.seekable.end(video.seekable.length - 1);
                    if (seekableEnd - video.currentTime > 3) {
                        // console.log('Seek to end', seekableEnd- video.currentTime)
                        video.currentTime = seekableEnd
                    }
                }
                
                console.log('buffer', { start: buffer.buffered.start(0), end: buffer.buffered.end(0), len: buffer.buffered.end(0) - buffer.buffered.start(0) })
                const bufferedLength = buffer.buffered.end(0) - buffer.buffered.start(0)
                if(!buffer.updating && bufferedLength > 60) {
                    buffer.remove(buffer.buffered.start(0), buffer.buffered.start(0) + (bufferedLength / 2))
                    console.log('...remove half of the buffer', { start: buffer.buffered.start(0), end: buffer.buffered.end(0), len: buffer.buffered.end(0) - buffer.buffered.start(0) })
                }
                
            }, 5000)

            return {
                handleData: (msgtype, data) => {
                    if(msgtype === 99) {
                        // ftyp_moov, reset sourceBuffer
                        buffer_index = 0;
                        frag_mp4_buffer = new Uint8Array(buffer_size);
                        if (buffer) {
                          buffer.abort()
                        }
                    }

                    if((buffer_index + data.length) <= buffer_size){
                        frag_mp4_buffer.set(data, buffer_index);
                        buffer_index = buffer_index + data.length;

                        if (!buffer.updating && mediaSource.readyState == 'open') {
                            var appended = frag_mp4_buffer.slice(0, buffer_index);

                            buffer.appendBuffer(appended);

                            frag_mp4_buffer.fill(0);
                            buffer_index = 0;
                        }
                    }
                }
            }
        }

        const buffers = {
            2: videoSource(2, '#videoPlayer1 > video'),
            3: videoSource(3, '#videoPlayer2 > video'),
            4: videoSource(4, '#videoPlayer3 > video'),
            5: videoSource(5, '#videoPlayer4 > video'),
            6: videoSource(6, '#videoPlayer5 > video'),
            7: videoSource(7, '#videoPlayer6 > video'),
            8: videoSource(8, '#videoPlayer7 > video')
        }

        var websocket = new WebSocket('ws://' + document.location.hostname +':8000');
        websocket.binaryType = 'arraybuffer';

        websocket.addEventListener('message', function(e) {
            var o = new Uint8Array(e.data);
            const id = o.slice(0, 1)[0]
            const msgtype = o.slice(1, 2)[0]
            // console.log('Header', { id, msgtype })
            const data = o.slice(2)

            if (data.length) {
                buffers[id].handleData(msgtype, data)
            }
        }, false);
        
    })();
    </script>

</body>
</html>
